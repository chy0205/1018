<!DOCTYPE html>
<html>
  <head>
    <base target="_top" /> <!-- è¨­å®šæ‰€æœ‰é€£çµåœ¨æ–°è¦–çª—é–‹å•Ÿ -->
    <style>
      /* =========================================== */
      /* å…¨åŸŸå’ŒåŸºç¤æ¨£å¼ */
      /* =========================================== */
      body {
        font-family: Arial, sans-serif; /* è¨­å®šå­—é«” */
        background-image: url('003.png'); /* ã€ä¿®æ”¹é»ã€‘æ›¿æ›èƒŒæ™¯åœ–ç‰‡ URL/è·¯å¾‘ */
        background-size: cover; /* ç¢ºä¿åœ–ç‰‡è¦†è“‹æ•´å€‹èƒŒæ™¯ */
        background-position: top center; /* åœ–ç‰‡å¾é ‚éƒ¨ä¸­å¤®é–‹å§‹é¡¯ç¤º */
        background-attachment: fixed; /* è®“èƒŒæ™¯åœ–ç‰‡ä¸éš¨å…§å®¹æ»¾å‹• */
        background-repeat: no-repeat; /* ä¸é‡è¤‡èƒŒæ™¯åœ–ç‰‡ */
        text-align: center; /* å…§æ–‡ç½®ä¸­å°é½Š */
        padding: 50px; /* é é¢é‚Šè· */
      }
      /* éš±è—éŸ³æ•ˆå…ƒç´ ï¼Œé¿å…åœ¨é é¢ä¸Šé¡¯ç¤ºæ’­æ”¾å™¨æ§åˆ¶é … */
      #spinSound, #finishSound {
        display: none; /* éš±è—éŸ³æ•ˆæ’­æ”¾å™¨ */
      }
        /* --------------------------------- */
        /* å½ˆå‡ºè¦–çª— (Modal) æ¨£å¼ */
        /* --------------------------------- */
        .modal {
            position: fixed; /* å›ºå®šåœ¨è¦–çª—ä¸Š */
            z-index: 100; /* ç¢ºä¿åœ¨æ‰€æœ‰å…ƒç´ ä¹‹ä¸Š */
            left: 0; /* å¾å·¦é‚Šç•Œé–‹å§‹ */
            top: 0; /* å¾é ‚éƒ¨é‚Šç•Œé–‹å§‹ */
            width: 100%; /* å¯¬åº¦ä½”æ»¿æ•´å€‹è¦–çª— */
            height: 100%; /* é«˜åº¦ä½”æ»¿æ•´å€‹è¦–çª— */
            overflow: auto; /* å…è¨±å…§å®¹æº¢å‡ºæ™‚æ»¾å‹• */
            background-color: rgba(0,0,0,0.6); /* é®ç½©èƒŒæ™¯è‰²å’Œé€æ˜åº¦ */
            display: flex; /* å•Ÿç”¨ Flexbox ä½ˆå±€ */
            align-items: center; /* å‚ç›´å±…ä¸­å…§å®¹ */
            justify-content: center; /* æ°´å¹³å±…ä¸­å…§å®¹ */
        }

        .modal-content {
            background-color: #fefefe; /* å…§å®¹æ¡†èƒŒæ™¯è‰² */
            padding: 2rem; /* å…§éƒ¨å¡«å……ç©ºé–“ */
            border-radius: 1.5rem; /* åœ“è§’è¨­å®š */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); /* å½ˆå‡ºæ¡†é™°å½± */
            text-align: center; /* æ–‡å­—å±…ä¸­å°é½Š */
            animation: fadeIn 0.3s ease-out; /* å½ˆå…¥å‹•ç•«æ•ˆæœ */
        }

        /* æŒ‰éˆ•æ¨£å¼ (é¸æ“‡åå–®æŒ‰éˆ•) */
        .modal-button {
            background-color: #ef4444; /* ç´…è‰²èƒŒæ™¯ */
            box-shadow: 0 4px #b91c1c; /* ç«‹é«”æ•ˆæœçš„é™°å½± (å‘ä¸‹ä½ç§» 4px) */
            /* å…¶ä»–æ¨£å¼... (æ­¤è™•å¯æ–°å¢æ›´å¤šæŒ‰éˆ•é€šç”¨æ¨£å¼) */
        }
        
        /* --------------------------------- */
        /* æŠ½ççµæœé¡¯ç¤ºæ¡† */
        /* --------------------------------- */
        .result-box {
            position: absolute; /* ç›¸å°å®šä½ (ç›¸å°æ–¼ body) */
            top: 37%; /* ã€èª¿æ•´ã€‘çµæœæ¡†çš„å‚ç›´ä½ç½® (0% ç‚ºé ‚éƒ¨) */
            left: 49.5%; /* ã€èª¿æ•´ã€‘çµæœæ¡†çš„æ°´å¹³ä½ç½® */
            transform: translate(-50%, -50%); /* ç¢ºä¿çµæœæ¡†ä¸­å¿ƒé»åœ¨ top/left çš„ä½ç½® (æ°´å¹³å’Œå‚ç›´ä½ç§» -50%) */
            width: 450px; /* ã€èª¿æ•´ã€‘çµæœæ¡†å¯¬åº¦ */
            height: 150px; /* ã€èª¿æ•´ã€‘çµæœæ¡†é«˜åº¦ */
            background-color: rgba(255, 255, 255, 0); /* ã€èª¿æ•´ã€‘çµæœæ¡†èƒŒæ™¯è‰² (0 ç‚ºé€æ˜) */
            
            /* -- å…§å®¹å±…ä¸­èˆ‡ç¾åŒ–è¨­å®š -- */
            border-radius: 0.75rem; /* è¨­å®šåœ“è§’æ•ˆæœï¼Œä½¿é‚Šè§’æ›´åœ“æ»‘ */
            display: flex; /* å•Ÿç”¨å½ˆæ€§ä½ˆå±€ (Flexbox) */
            justify-content: center; /* å°‡å…§å®¹ï¼ˆæ–‡å­—ï¼‰åœ¨æ°´å¹³æ–¹å‘ä¸Šç½®ä¸­ */
            align-items: center; /* å°‡å…§å®¹ï¼ˆæ–‡å­—ï¼‰åœ¨å‚ç›´æ–¹å‘ä¸Šç½®ä¸­ */
            /* ---------------------------------------------------- */
            
            font-size: 4rem; /* ã€èª¿æ•´ã€‘çµæœæ–‡å­—çš„å¤§å° */
            font-weight: 700; /* å­—é«”åŠ ç²— */
            color: #4b5563; /* ã€èª¿æ•´ã€‘çµæœæ–‡å­—çš„é¡è‰² */
            box-shadow: inset 0 3px 5px rgba(0,0,0,0.1); /* å…§éƒ¨é™°å½±ï¼Œå¢åŠ ç«‹é«”æ„Ÿ */
            pointer-events: none; /* è®“æ»‘é¼ äº‹ä»¶ç©¿é€æ­¤å…ƒç´ ï¼Œä¸æœƒæ“‹ä½ä¸‹å±¤å…ƒç´  */
            z-index: 10; /* å±¤ç´šè¨­å®š */
        }
        
        /* --------------------------------- */
        /* ä¸»è¦æŒ‰éˆ•çµ„ (é–‹å§‹æŠ½ç/æ¸…é™¤ç´€éŒ„) */
        /* --------------------------------- */
        .button-group {
            display: flex; /* å•Ÿç”¨å½ˆæ€§ä½ˆå±€ï¼Œä½¿æŒ‰éˆ•ä¸¦æ’é¡¯ç¤º */
            gap: 1rem; /* æŒ‰éˆ•ä¹‹é–“çš„é–“éš” */
            z-index: 20; /* ç¢ºä¿æŒ‰éˆ•åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
            position: absolute; /* ç›¸å° body å®šä½ */
            top: 51%; /* ã€èª¿æ•´ã€‘æŒ‰éˆ•çµ„çš„å‚ç›´ä½ç½® (è¦é…åˆèƒŒæ™¯åœ–) */
            left: 50%; /* æ°´å¹³ä¸­å¤®ä½ç½® */
            transform: translate(-50%, 0px); /* æ°´å¹³ç½®ä¸­ (å‘å·¦ç§»å‹•å¯¬åº¦çš„ä¸€åŠ) */
        }
        
        /* ä¸»è¦æŒ‰éˆ•æ¨£å¼ */
        .button {
            padding: 0.75rem 1.5rem; /* å…§éƒ¨å¡«å……ç©ºé–“ */
            border: none; /* ç§»é™¤é‚Šæ¡† */
            border-radius: 0.5rem; /* åœ“è§’ */
            cursor: pointer; /* é¼ æ¨™è®Šæˆæ‰‹å‹ */
            transition: background-color 0.2s; /* é¡è‰²è½‰æ›å‹•ç•«æ™‚é–“ */
            font-weight: 600; /* å­—é«”ç²—ç´° */
            background-color: #d1d5db; /* é è¨­èƒŒæ™¯è‰² */
            color: #1f2937; /* æ–‡å­—é¡è‰² */
        }
        /* æ‡¸åœæ•ˆæœ (Hover) */
        .button:hover {
            background-color: #9ca3af; /* æ‡¸åœæ™‚é¡è‰²è®Šæ·± */
        }

        /* --------------------------------- */
        /* æç¤ºè¨Šæ¯ (å¦‚ï¼šå·²æŠ½å‡ºã€åå–®å·²æŠ½å®Œ) */
        /* --------------------------------- */
        .message {
            font-size: 1.25rem; /* å­—é«”å¤§å° */
            font-weight: 700; /* å­—é«”åŠ ç²— */
            min-height: 2rem; /* æœ€å°é«˜åº¦ */
            color: #ffffff; /* æ–‡å­—é¡è‰²è¨­ç‚ºç™½è‰² */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8); /* æ–‡å­—é™°å½±ï¼Œä½¿æ–‡å­—åœ¨èƒŒæ™¯ä¸Šæ›´æ¸…æ™° */
            z-index: 20; /* å±¤ç´šè¨­å®š */
            position: absolute; /* ç›¸å° body å®šä½ */
            top: 50%; /* ã€èª¿æ•´ã€‘æç¤ºè¨Šæ¯çš„å‚ç›´ä½ç½® */
            left: 50%; /* æ°´å¹³ä¸­å¤®ä½ç½® */
            transform: translate(-50%, 70px); /* æ°´å¹³ç½®ä¸­ä¸¦å‘ä¸‹ç§»å‹• 70px */
        }

        /* --------------------------------- */
        /* æŠ½çç´€éŒ„å€å¡Š */
        /* --------------------------------- */
        .history-container {
            width: 350px; /* ã€èª¿æ•´ã€‘ç´€éŒ„å€å¡Šå¯¬åº¦ */
            padding: 1rem; /* å…§éƒ¨å¡«å…… */
            text-align: left; /* æ–‡å­—é å·¦å°é½Š */
            background-color: rgba(255, 255, 255, 0.6); /* ç´€éŒ„å€å¡ŠèƒŒæ™¯è‰² (åŠé€æ˜) */
            border-radius: 1rem; /* åœ“è§’è¨­å®š */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* å€å¡Šé™°å½± */
            z-index: 20; /* å±¤ç´šè¨­å®š */
            position: absolute; /* ç›¸å° body å®šä½ */
            top: 50%; /* ã€èª¿æ•´ã€‘ç´€éŒ„å€å¡Šçš„å‚ç›´ä½ç½® */
            left: 50%; /* æ°´å¹³ä¸­å¤®ä½ç½® */
            transform: translate(-50%, 140px); /* æ°´å¹³ç½®ä¸­ä¸¦å‘ä¸‹ç§»å‹• 140px */
        }
        
        .history-list {
            max-height: 100px; /* ã€èª¿æ•´ã€‘ç´€éŒ„æ¸…å–®çš„æœ€å¤§é«˜åº¦ï¼Œè¶…éæœƒå‡ºç¾å‚ç›´æ²è»¸ */
            overflow-y: auto; /* è¶…å‡ºé«˜åº¦æ™‚é¡¯ç¤ºå‚ç›´æ²è»¸ */
        }

        .history-item {
            padding: 0.25rem 0; /* ä¸Šä¸‹å…§é‚Šè· */
            border-bottom: 1px solid #e5e7eb; /* åº•éƒ¨ç´°ç·šåˆ†éš” */
            font-size: 0.9rem; /* å­—é«”å¤§å° */
        }
        /* ç§»é™¤æœ€å¾Œä¸€é …ç´€éŒ„çš„åº•ç·šï¼Œé¿å…è¦–è¦ºå¤šé¤˜ */
        .history-item:last-child {
            border-bottom: none; /* ç§»é™¤æœ€å¾Œä¸€å€‹é …ç›®çš„åº•ç·š */
        }
    </style>
</head>
<body>
    <!-- å½ˆå‡ºè¦–çª—å€å¡Š (åå–®é¸æ“‡) -->
    <div id="modalContainer" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold">è«‹é¸æ“‡è¦ä½¿ç”¨çš„åå–®ï¼š</h2>
            <div class="modal-button-group">
                <button id="selectList1Btn" class="modal-button">çµ„åˆ¥</button>
                <button id="selectList2Btn" class="modal-button">å€‹äºº</button>
            </div>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div id="pickerContainer">
        <!-- æ ¸å¿ƒåŠŸèƒ½å€å¡Š -->
        <div id="resultBox" class="result-box">--</div>
        <div class="button-group">
            <button id="pickBtn" class="button" disabled>é–‹å§‹æŠ½ç</button>
            <button id="clearHistoryBtn" class="button">æ¸…é™¤ç´€éŒ„</button>
        </div>
        
        <div id="message" class="message"></div>

        <div class="history-container">
            <div class="flex justify-between items-center mb-2">
                <h2 class="history-title">æŠ½çç´€éŒ„</h2>
                <span id="historyCount" class="text-sm text-gray-500"></span>
            </div>
            <ul id="historyList" class="history-list">
                <!-- è¨˜éŒ„å°‡åœ¨é€™è£¡é¡¯ç¤º -->
            </ul>
        </div>
    </div>

    <!-- éŸ³æ•ˆå…ƒç´  (éš±è—) -->
    <!-- è½‰å‹•éŸ³æ•ˆ (Loop å¾ªç’°æ’­æ”¾) -->
    <audio id="spinSound" src="002.mp3" loop preload="auto"></audio> <!-- ã€ä¿®æ”¹é»ã€‘æ›¿æ›è½‰å‹•éŸ³æ•ˆæª”æ¡ˆè·¯å¾‘ -->
    <!-- çµæŸ/æˆåŠŸéŸ³æ•ˆ (è¼ƒé•·ï¼Œç”¨æ–¼é¸å–ç‰¹å®šç‰‡æ®µ) -->
    <audio id="finishSound" src="002.mp3" preload="auto"></audio> <!-- ã€ä¿®æ”¹é»ã€‘æ›¿æ›çµæŸéŸ³æ•ˆæª”æ¡ˆè·¯å¾‘ -->

    <script>
        // ===========================================
        // è¨­å®šå€å¡Š
        // ===========================================
        const SPREADSHEET_ID = '1r24BcBG0KjRdre8Uh2zp9UlcaG5DTdwdtZrt0bqOC44'; // ã€ä¿®æ”¹é»ã€‘æ‚¨çš„ Google è©¦ç®—è¡¨ ID
        const GIDS = { // å®šç¾©åå–®åç¨±èˆ‡å…¶å°æ‡‰çš„ GID
            'åå–®ä¸€': '921041441', // ã€ä¿®æ”¹é»ã€‘åå–®ä¸€ (çµ„åˆ¥) æ‰€åœ¨å·¥ä½œè¡¨çš„åˆ†é  ID (GID)
            'åå–®äºŒ': '824754110' // ã€ä¿®æ”¹é»ã€‘åå–®äºŒ (å€‹äºº) æ‰€åœ¨å·¥ä½œè¡¨çš„åˆ†é  ID (GID)
        };
        
        // ===========================================
        // ç²å–éŸ³æ•ˆå…ƒç´ åŠåŠŸèƒ½æ¨¡çµ„
        // ===========================================
        const spinSound = document.getElementById('spinSound'); // å–å¾—è½‰å‹•éŸ³æ•ˆå…ƒç´ 
        const finishSound = document.getElementById('finishSound'); // å–å¾—çµæŸéŸ³æ•ˆå…ƒç´ 

        /**
         * æ’­æ”¾è½‰å‹•/æŒçºŒéŸ³æ•ˆã€‚
         */
        function playSpinSound() {
            if (spinSound) { // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
                spinSound.currentTime = 0; // é‡ç½®åˆ°é–‹é ­ï¼Œç¢ºä¿æ¯æ¬¡éƒ½å¾é ­æ’­æ”¾
                spinSound.play().catch(e => console.log("è½‰å‹•éŸ³é »æ’­æ”¾å¤±æ•—:", e)); // å˜—è©¦æ’­æ”¾ä¸¦æ•æ‰æ½›åœ¨éŒ¯èª¤
            }
        }

        /**
         * åœæ­¢è½‰å‹•éŸ³æ•ˆã€‚
         */
        function stopSpinSound() {
            if (spinSound) { // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
                spinSound.pause(); // æš«åœæ’­æ”¾
                spinSound.currentTime = 0; // é‡ç½®åˆ°é–‹é ­ï¼Œç‚ºä¸‹æ¬¡æ’­æ”¾åšæº–å‚™
            }
        }

        /**
         * æ’­æ”¾çµæŸéŸ³æ•ˆçš„ç‰¹å®šå€æ®µã€‚
         * @param {number} startTime - éŸ³æ•ˆé–‹å§‹æ’­æ”¾çš„ç§’æ•¸ (ä¾‹å¦‚ 9)ã€‚
         * @param {number} duration - éŸ³æ•ˆæŒçºŒæ’­æ”¾çš„ç§’æ•¸ (ä¾‹å¦‚ 2)ã€‚
         */
        function playFinishSound(startTime, duration) {
            if (finishSound) { // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
                finishSound.currentTime = startTime; // è¨­å®šæ’­æ”¾èµ·é» (ç§’)
                finishSound.play().catch(e => console.log("çµæŸéŸ³é »æ’­æ”¾å¤±æ•—:", e)); // å˜—è©¦æ’­æ”¾éŸ³æ•ˆ

                // è¨­å®šåœ¨æŒ‡å®šç§’æ•¸å¾Œåœæ­¢æ’­æ”¾
                setTimeout(() => {
                    finishSound.pause(); // æš«åœæ’­æ”¾
                    finishSound.currentTime = 0; // é‡ç½®åˆ°é–‹é ­
                }, duration * 1000); // å°‡æŒçºŒæ™‚é–“å¾ç§’è½‰æ›ç‚ºæ¯«ç§’
            }
        }

        /**
         * åœæ­¢æ‰€æœ‰éŸ³æ•ˆï¼ˆç”¨æ–¼é‡æ–°é–‹å§‹æˆ–é‡è¨­ï¼‰ã€‚
         */
        function stopAllSounds() {
            stopSpinSound(); // åœæ­¢è½‰å‹•éŸ³æ•ˆ
            if (finishSound) { // æª¢æŸ¥çµæŸéŸ³æ•ˆå…ƒç´ 
                finishSound.pause(); // æš«åœçµæŸéŸ³æ•ˆ
                finishSound.currentTime = 0; // é‡ç½®çµæŸéŸ³æ•ˆé€²åº¦
            }
        }
        // ===========================================
        
        // å–å¾— UI å…ƒç´  (DOM å¼•ç”¨)
        const modalContainer = document.getElementById('modalContainer'); // å–å¾—åå–®é¸æ“‡å½ˆå‡ºè¦–çª—å…ƒç´ 
        const selectList1Btn = document.getElementById('selectList1Btn'); // å–å¾—åå–®ä¸€ (çµ„åˆ¥) æŒ‰éˆ•
        const selectList2Btn = document.getElementById('selectList2Btn'); // å–å¾—åå–®äºŒ (å€‹äºº) æŒ‰éˆ•
        
        const resultBox = document.getElementById('resultBox'); // å–å¾—é¡¯ç¤ºæŠ½ççµæœçš„æ–¹æ¡†
        const pickBtn = document.getElementById('pickBtn'); // å–å¾—ã€Œé–‹å§‹æŠ½çã€æŒ‰éˆ•
        const messageDiv = document.getElementById('message'); // å–å¾—é¡¯ç¤ºæç¤ºè¨Šæ¯çš„å€å¡Š
        const historyList = document.getElementById('historyList'); // å–å¾—æ­·å²ç´€éŒ„æ¸…å–® (UL)
        const historyCountSpan = document.getElementById('historyCount'); // å–å¾—æ­·å²ç´€éŒ„è¨ˆæ•¸é¡¯ç¤ºå€
        const clearHistoryBtn = document.getElementById('clearHistoryBtn'); // å–å¾—ã€Œæ¸…é™¤ç´€éŒ„ã€æŒ‰éˆ•
        
        // ç‹€æ…‹è®Šæ•¸
        let currentGid = ''; // ç•¶å‰é¸ä¸­çš„åå–® GID (å·¥ä½œè¡¨åˆ†é  ID)
        let teamsData = []; // å°šæœªæŠ½å‡ºçš„åå–®é™£åˆ— (æ¯æ¬¡æŠ½å‡ºæœƒæ¸›å°‘)
        let allData = {};   // å®Œæ•´çš„åå–®è³‡æ–™å¿«å– (ç”¨æ–¼äº‚æ•¸è·³å‹•é¡¯ç¤º)
        let isPicking = false; // æŠ½çå‹•ç•«æ˜¯å¦æ­£åœ¨é€²è¡Œä¸­ (å¸ƒæ—å€¼)
        let drawHistory = []; // å·²æŠ½å‡ºçš„ç´€éŒ„é™£åˆ—
        
        /**
         * ç•°æ­¥å‡½æ•¸ï¼šå¾ Google è©¦ç®—è¡¨ç²å–åå–®æ•¸æ“š
         * å‚™è¨»ï¼šä½¿ç”¨ Google Visualization API (gviz) æ¥å£ä¾†ç²å– JSON æ ¼å¼æ•¸æ“šã€‚
         * @param {string} gid - å·¥ä½œè¡¨çš„åˆ†é  IDã€‚
         * @returns {Promise<string[]>} - åå–®é™£åˆ—ã€‚
         */
        async function fetchTeamsData(gid) {
            try {
                if (allData[gid]) { // æª¢æŸ¥å¿«å–ä¸­æ˜¯å¦å·²æœ‰æ•¸æ“š
                    return allData[gid]; // å¦‚æœå·²ç¶“å¿«å–ï¼Œå‰‡ç›´æ¥è¿”å›ï¼Œé¿å…é‡è¤‡è«‹æ±‚
                }

                const TEAMS_SHEET_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`; // æ§‹é€  API è«‹æ±‚ URL
                
                const response = await fetch(TEAMS_SHEET_URL); // ç™¼é€ç¶²çµ¡è«‹æ±‚ç²å–æ•¸æ“š
                const text = await response.text(); // ç²å–éŸ¿æ‡‰æ–‡æœ¬
                
                // è™•ç† JSONP æ ¼å¼ (ç§»é™¤ Google ç‰¹æœ‰çš„åŒ…è£å­—ä¸²)
                const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1); // æå–ç´” JSON å…§å®¹
                const data = JSON.parse(jsonText); // å°‡ JSON å­—ä¸²è§£æç‚º JavaScript ç‰©ä»¶

                // è§£æè©¦ç®—è¡¨æ•¸æ“š
                const parsedData = data.table.rows.map(row => { // éæ­·æ¯ä¸€è¡Œæ•¸æ“š
                    // å‡è¨­åå–®åœ¨ç¬¬ A, B å…©æ¬„ (c[0], c[1])
                    if (row.c.length > 1 && row.c[1] && row.c[1].v) {
                        return `${row.c[0].v}: ${row.c[1].v}`; // çµ„åˆ: å§“å (å–å…©æ¬„æ•¸æ“š)
                    } else if (row.c[0] && row.c[0].v) {
                        return row.c[0].v; // åªæœ‰å§“å/çµ„åˆ¥å (å–ç¬¬ä¸€æ¬„æ•¸æ“š)
                    }
                    return null; // å¦‚æœæ•¸æ“šç„¡æ•ˆå‰‡è¿”å› null
                }).filter(item => item !== null); // éæ¿¾æ‰ç©ºè¡Œ (null å€¼)

                allData[gid] = parsedData; // å„²å­˜å¿«å–
                return parsedData; // è¿”å›è§£æå¾Œçš„åå–®

            } catch (error) {
                console.error('è¼‰å…¥å§“åè³‡æ–™å¤±æ•—:', error); // æ‰“å°éŒ¯èª¤è¨Šæ¯åˆ°æ§åˆ¶å°
                if (messageDiv) {
                    messageDiv.textContent = 'è¼‰å…¥è³‡æ–™å¤±æ•—ã€‚è«‹æª¢æŸ¥æ‚¨çš„è©¦ç®—è¡¨ç¶²å€å’Œæ¬Šé™è¨­å®šã€‚'; // é¡¯ç¤ºéŒ¯èª¤æç¤º
                }
                return []; // è¿”å›ç©ºé™£åˆ—
            }
        }

        /**
         * é‡æ–°è¼‰å…¥åå–®ä¸¦é‡ç½®ç‹€æ…‹ã€‚åœ¨åˆ‡æ›åå–®å’Œæ¸…é™¤ç´€éŒ„æ™‚èª¿ç”¨ã€‚
         */
        async function updateList() {
            const fetchedData = await fetchTeamsData(currentGid); // ç²å–é¸å®šçš„åå–®æ•¸æ“š
            teamsData = [...fetchedData]; // è¤‡è£½å®Œæ•´åå–®åˆ°å¾…æŠ½åå–® (ä½¿ç”¨å±•é–‹é‹ç®—ç¬¦é¿å…å¼•ç”¨)
            
            if (teamsData.length > 0) { // æª¢æŸ¥åå–®æ˜¯å¦æœ‰å…§å®¹
                resultBox.textContent = 'æº–å‚™å¥½äº†ï¼'; // é¡¯ç¤ºæº–å‚™è¨Šæ¯
                pickBtn.disabled = false; // å•Ÿç”¨æŠ½çæŒ‰éˆ•
                if (messageDiv) {
                    messageDiv.textContent = ''; // æ¸…ç©ºæç¤ºè¨Šæ¯
                }
            } else {
                resultBox.textContent = 'è¼‰å…¥å¤±æ•—'; // é¡¯ç¤ºè¼‰å…¥å¤±æ•—è¨Šæ¯
                pickBtn.disabled = true; // ç¦ç”¨æŠ½çæŒ‰éˆ•
                if (messageDiv) {
                    messageDiv.textContent = 'è©¦ç®—è¡¨ä¸­æ²’æœ‰æ‰¾åˆ°å¯ç”¨çš„å§“åè³‡æ–™ã€‚'; // é¡¯ç¤ºéŒ¯èª¤æç¤º
                }
            }
            drawHistory = []; // æ¸…ç©ºæ­·å²ç´€éŒ„é™£åˆ—
            renderHistory(); // æ›´æ–°æ­·å²ç´€éŒ„é¡¯ç¤º
        }

        /**
         * æ¸²æŸ“æ­·å²ç´€éŒ„åˆ—è¡¨ï¼Œæ–°ç´€éŒ„æœƒé¡¯ç¤ºåœ¨æœ€ä¸Šæ–¹ã€‚
         */
        function renderHistory() {
            historyList.innerHTML = ''; // æ¸…ç©ºç¾æœ‰åˆ—è¡¨ (DOM æ“ä½œ)
            drawHistory.forEach((item, index) => { // éæ­·å·²æŠ½å‡ºçš„ç´€éŒ„
                const li = document.createElement('li'); // å‰µå»ºæ–°çš„åˆ—è¡¨é …ç›®å…ƒç´ 
                li.className = 'history-item'; // è¨­å®š CSS é¡åˆ¥
                li.textContent = `${index + 1}. ${item}`; // è¨­å®šé¡¯ç¤ºçš„æ–‡å­—å…§å®¹ (ç·¨è™Ÿ + å§“å)
                historyList.prepend(li); // å°‡æ–°é …ç›®æ·»åŠ åˆ°æ¸…å–®çš„æœ€é–‹é ­
            });
            historyCountSpan.textContent = `å·²æŠ½å‡ºï¼š${drawHistory.length}äºº`; // æ›´æ–°è¨ˆæ•¸å™¨çš„é¡¯ç¤ºæ–‡å­—
        }

        /**
         * é–‹å§‹æŠ½ççš„ä¸»è¦é‚è¼¯ï¼šåŸ·è¡Œäº‚æ•¸è·³å‹•å‹•ç•«ä¸¦é¸å®šçµæœã€‚
         */
        function startPicking() {
            if (isPicking || teamsData.length === 0) { // æª¢æŸ¥æ˜¯å¦æ­£åœ¨æŠ½çæˆ–åå–®æ˜¯å¦ç‚ºç©º
                if (teamsData.length === 0 && messageDiv) {
                    messageDiv.textContent = 'åå–®å·²æŠ½å®Œï¼Œè«‹é»æ“Šã€Œæ¸…é™¤ç´€éŒ„ã€é‡æ–°é–‹å§‹ã€‚'; // é¡¯ç¤ºæŠ½å®Œæç¤º
                }
                return; // é€€å‡ºå‡½æ•¸
            }

            isPicking = true; // è¨­å®šæŠ½çç‹€æ…‹ç‚ºé€²è¡Œä¸­
            pickBtn.disabled = true; // ç¦ç”¨æŠ½çæŒ‰éˆ•ï¼Œé˜²æ­¢é‡è¤‡é»æ“Š
            if (messageDiv) {
                messageDiv.textContent = ''; // æ¸…ç©ºæç¤ºè¨Šæ¯
            }
            
            // æ­¥é©Ÿ 1: æ’­æ”¾è½‰å‹•éŸ³æ•ˆ (loop æ¨¡å¼)
            playSpinSound(); // æ’­æ”¾éŸ³æ•ˆ

            let count = 0; // äº‚æ•¸è·³å‹•è¨ˆæ•¸å™¨
            // äº‚æ•¸è·³å‹•æ™‚ï¼Œä½¿ç”¨å®Œæ•´çš„åå–® (allData) ä¾†å¢åŠ è¦–è¦ºè±å¯Œåº¦
            const originalData = allData[currentGid]; // ç²å–å®Œæ•´åå–®
            
            const pickingInterval = setInterval(() => { // è¨­å®šå®šæ™‚å™¨ï¼Œé–‹å§‹äº‚æ•¸è·³å‹•
                const randomIndex = Math.floor(Math.random() * originalData.length); // äº‚æ•¸é¸æ“‡ä¸€å€‹ç´¢å¼•
                const item = originalData[randomIndex]; // å–å¾—è©²ç´¢å¼•å°æ‡‰çš„é …ç›®
                
                resultBox.textContent = item; // åœ¨çµæœæ¡†é¡¯ç¤ºäº‚æ•¸çµæœ
                
                count++; // å¢åŠ è¨ˆæ•¸

                if (count > 30) { // ã€èª¿æ•´ã€‘äº‚æ•¸è·³å‹•çš„ç¸½æ¬¡æ•¸ (é”åˆ°æ¬¡æ•¸å¾Œåœæ­¢)
                    clearInterval(pickingInterval); // æ¸…é™¤å®šæ™‚å™¨ï¼Œåœæ­¢äº‚æ•¸è·³å‹•
                    isPicking = false; // è¨­å®šæŠ½çç‹€æ…‹ç‚ºéé€²è¡Œä¸­
                    
                    // æ­¥é©Ÿ 2: åœæ­¢è½‰å‹•éŸ³æ•ˆ
                    stopSpinSound(); // åœæ­¢æŒçºŒçš„è½‰å‹•éŸ³æ•ˆ

                    // ç¢ºå®šæœ€çµ‚çµæœå¾å°šæœªæŠ½å‡ºçš„åå–® (teamsData) ä¸­é¸å–
                    const finalIndex = Math.floor(Math.random() * teamsData.length); // äº‚æ•¸é¸æ“‡æœ€çµ‚çµæœçš„ç´¢å¼•
                    const finalItem = teamsData[finalIndex]; // æ ¹æ“šç´¢å¼•å–å¾—æœ€çµ‚çµæœ
                    
                    resultBox.textContent = finalItem; // åœ¨çµæœæ¡†é¡¯ç¤ºæœ€çµ‚çµæœ
                    
                    // æ­¥é©Ÿ 3: æ’­æ”¾çµæŸéŸ³æ•ˆ (åªæ’­ç‰¹å®šç‰‡æ®µ)
                    playFinishSound(9, 2); // ã€èª¿æ•´ã€‘éŸ³æ•ˆåƒæ•¸ï¼šå¾ç¬¬ 9 ç§’é–‹å§‹æ’­ï¼ŒæŒçºŒ 2 ç§’
                    
                    if (messageDiv) {
                        messageDiv.textContent = 'ğŸ‰ æŠ½å‡º: ' + finalItem + ' ğŸ‰'; // é¡¯ç¤ºæœ€çµ‚çµæœçš„æç¤ºæ–‡å­—
                    }
                    drawHistory.push(finalItem); // å°‡çµæœåŠ å…¥æ­·å²ç´€éŒ„
                    teamsData.splice(finalIndex, 1); // å°‡å·²æŠ½å‡ºçš„å¾å¾…æŠ½åå–®ä¸­ç§»é™¤
                    renderHistory(); // æ›´æ–°æ­·å²ç´€éŒ„é¡¯ç¤º
                    
                    if (teamsData.length > 0) { // æª¢æŸ¥æ˜¯å¦é‚„æœ‰å¾…æŠ½åå–®
                        pickBtn.disabled = false; // å¦‚æœé‚„æœ‰åå–®ï¼Œå‰‡å•Ÿç”¨æŒ‰éˆ•
                    } else {
                        pickBtn.disabled = true; // å¦‚æœåå–®å·²æŠ½å®Œï¼Œå‰‡ç¦ç”¨æŒ‰éˆ•
                        if (messageDiv) {
                            messageDiv.textContent = 'åå–®å·²æŠ½å®Œï¼è«‹é»æ“Šã€Œæ¸…é™¤ç´€éŒ„ã€é‡æ–°é–‹å§‹ã€‚'; // é¡¯ç¤ºåå–®æŠ½å®Œæç¤º
                        }
                    }
                }
            }, 50); // ã€èª¿æ•´ã€‘äº‚æ•¸è·³å‹•çš„é€Ÿåº¦ (50æ¯«ç§’ï¼Œæ•¸å­—è¶Šå°è½‰é€Ÿè¶Šå¿«)
        }

        /**
         * æ¸…é™¤æ­·å²ç´€éŒ„ä¸¦é‡è¨­åå–® (æ¢å¾©åˆ°å®Œæ•´åå–®)
         */
        function clearHistory() {
            // æ­¥é©Ÿ 4: æ¸…é™¤ç´€éŒ„æ™‚åœæ­¢æ‰€æœ‰éŸ³æ•ˆ
            stopAllSounds(); // åœæ­¢æ‰€æœ‰æ­£åœ¨æ’­æ”¾çš„éŸ³æ•ˆ

            drawHistory = []; // æ¸…ç©ºç´€éŒ„é™£åˆ—
            renderHistory(); // æ›´æ–°æ­·å²ç´€éŒ„é¡¯ç¤º (æ¸…ç©ºåˆ—è¡¨)
            updateList(); // é‡è¼‰åå–® (å°‡ teamsData æ¢å¾©åˆ°å®Œæ•´åå–®)
            if (messageDiv) {
                messageDiv.textContent = 'ç´€éŒ„å·²æ¸…é™¤ï¼Œåå–®å·²é‡ç½®ã€‚'; // é¡¯ç¤ºæ¸…é™¤ç´€éŒ„å¾Œçš„æç¤ºæ–‡å­—
            }
        }
        
        /**
         * è™•ç†åå–®é¸æ“‡æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
         * @param {string} listName - 'åå–®ä¸€' æˆ– 'åå–®äºŒ'
         */
        function handleListSelection(listName) {
            currentGid = GIDS[listName]; // è¨­å®šç•¶å‰ GID
            modalContainer.style.display = 'none'; // éš±è—è¦–çª—
            updateList(); // è¼‰å…¥é¸å®šçš„åå–®
        }

        // äº‹ä»¶ç›£è½å™¨
        pickBtn.addEventListener('click', startPicking); // ç›£è½ã€Œé–‹å§‹æŠ½çã€æŒ‰éˆ•é»æ“Šäº‹ä»¶
        clearHistoryBtn.addEventListener('click', clearHistory); // ç›£è½ã€Œæ¸…é™¤ç´€éŒ„ã€æŒ‰éˆ•é»æ“Šäº‹ä»¶

        selectList1Btn.addEventListener('click', () => handleListSelection('åå–®ä¸€')); // ç›£è½åå–®ä¸€æŒ‰éˆ•é»æ“Š
        selectList2Btn.addEventListener('click', () => handleListSelection('åå–®äºŒ')); // ç›£è½åå–®äºŒæŒ‰éˆ•é»æ“Š

        // é é¢è¼‰å…¥æ™‚ï¼šé¡¯ç¤ºå½ˆå‡ºè¦–çª—è®“ä½¿ç”¨è€…é¸æ“‡åå–®
        document.addEventListener('DOMContentLoaded', () => { // ç•¶é é¢ HTML çµæ§‹å®Œå…¨è¼‰å…¥å¾ŒåŸ·è¡Œ
             modalContainer.style.display = 'flex'; // ç¢ºä¿åˆå§‹é¡¯ç¤ºåå–®é¸æ“‡è¦–çª—
        });
    </script>
</body>
</html>
